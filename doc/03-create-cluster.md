# Creating cluster

## Initialize cluster
We are going to create a single master node K8s cluster. Execute the following script to init the cluster via kubeadm:
```shell
sudo kubeadm init --pod-network-cidr 192.168.0.0/16 --service-cidr 10.96.0.0/16
```
Let's break down some of the arguments:
- `--pod-network-cidr` network of the pods. The value provided here is to be compatible with the networking plugin
- `--service-cidr` When services are created in Kubernetes, they are assigned a VIP from the specified. Should not overlap with the pod network or any other networks in use within your cluster.

> ðŸ’¡ This `kubeadm` command might require you to specify `--cri-socket` argument. Please refer to your installed container engine installation document, which you have completed earler.

Possible `--cri-socket` values are:
- `--cri-socket unix:///var/run/containerd/containerd.sock`
- `--cri-socket unix:///var/run/crio/crio.sock`
- `--cri-socket unix:///var/run/cri-dockerd.sock`

### Extra arguments
Here are some optional arguments

- `--apiserver-advertise-address` Private IP address of the master node. This IP should  be accessible by other nodes in the same cluster. If there are more than single IP, this is required. `$(ip route get 8.8.8.8 | sed -n 's/.*src \([^\ ]*\).*/\1/p')` automatically getting the IP address from the network interface.

- `--apiserver-cert-extra-sans=<Private IP>,<Public IP>`. The k8s api server is using ssl (https). Therefore therse should be a certificate for each accessible address. If you want to use `kubectl` over the public ip or DNS, those should be added within `--apiserver-cert-extra-sans` argument, each separated via comma `,`. Do not forget to add private ip too.  
  Here is an example: `--apiserver-cert-extra-sans=10.6.0.7,89.168.95.222`

For more information please check official documentation: [Creating a cluster with kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)

## Post init
When *kubeadm* finishes, you will get an output that looks like this:
```
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 10.6.0.56:6443 --token inx5ge.z8lgw44zr3ui9r4t \
        --discovery-token-ca-cert-hash sha256:a8958c7cfa5e57db14e299c98cd466aa6f54821a1a6676d802f474f5e20a0626 
```

It is essential to perform:
```shell
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

Note the last command from the tool. This `kubeadm join ...` command generated by the kubeadm, will be used **on the worker nodes** to have them joining to the cluster. Do not loose that command. We will be using it later.

The token provided there is time-bound; it will expire in 23H. When it is expired (or lost), you can generate new one. This will not revoke the previous token/command.
```shell
sudo kubeadm token create --print-join-command
```
You can use the same join command on multiple worker nodes. No need to use separate for each.

> ðŸš¨ Do not execute join command on the master node.

